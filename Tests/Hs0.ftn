      PROGRAM SQUONK
      COMMON/CB14/ICHECK
      ICHECK=0
      CALL SETUP
      CALL DOSUMS
      CALL OUTPUT
      STOP
      END
C
C******
C
C
      SUBROUTINE DOSUMS
      COMMON/CB01/DCSL(10),BETA(10),SNA(10),C0(10),X0ALO(10),
     XX0SIO(10),D(10),VB(10),CM0(10),SND(10)
      COMMON/CB05/NSET,ISET,NSTEP,ISTEP
C      ROUTINE TO OVERSEE THE GENERATION OF ALL THE CURVES TO BE PLOTTED
      COMMON/CB07/PHIS,VI,PSIL,VA,VALOX,VGATE,VSIOX
      COMMON/CB14/ICHECK
      COMMON/CB15/IPTR,POSSVA(2,100),LPOSVA
      LSET=2
      LSET=NSET
      DO 100 ISET=1,LSET
      CALL DOASUM
100   CONTINUE
C      SAVE FINAL SET COUNT IN NON-VOLATILE VARIABLE
      ISET=LSET
      RETURN
      END
C
C******
C
C
      SUBROUTINE DOASUM
      COMMON/CB01/DCSL(10),BETA(10),SNA(10),C0(10),X0ALO(10),
     XX0SIO(10),D(10),VB(10),CM0(10),SND(10)
      COMMON/CB05/NSET,ISET,NSTEP,ISTEP
      COMMON/CB06/C1,C2,C3,C4,C5,C6,C7,VINV,EINV,VSTART,VEND
      COMMON/CB17/TOTUAQ,TOTUSL,TOTUSI,UMIN,UTOT
C      ROUTINE TO GENERATE ONE PROFILE, GIVEN A SET OF PARAMETERS
C      DEFINED BY ISET
C      UNFORTUNATELY, THE SOLUTION OF F(VA) = 0.0 IS NOT UNIQUE.
C      SO STRATEGY IS AS FOLLOWS:
C      SUBROUTINE CKPLOT MOOCHES ALONG THE VA AXIS, STARTING AT VSTART
C      AND ENDING AT VEND. EVERY TIME F CROSSES 0.0, THE V-VALUES OF
C      THE TESTED POINTS ON EITHER SIDE OF THE CROSSING ARE LOADED INTO
C      POSSVA, AND THE POINTER INCREMENTED. SO, ON EXIT FROM
C      SUBROUTINE CKPLOT, IPTR CONTAINS THE NUMBER OF ZERO CROSSINGS,
C      AND POSSVA (1,X),(2,X) THE STRADDLING VOLTAGES FOR THE
C      BISECTION ROUTINE. THEN SUBROUTINE CLOSLP TAKES EACH CROSSING
C      POINT IN TURN, AND SOLVES THE COMPLETE SYSTEM FOR IT. SUBROUTINE
C      ENERGY CALCULATES THE TOTAL ELECTROSTATIC ENERGY FOR THE SYSTEM
C      GIVEN THE CURRENT SET OF BOUNDARY CONDITIONS CALCULATED BY
C      CLOSLP. IF THE ENERGY IS AT AN ALL-TIME LOW, ENERGY STORES
C      THE BOUNDARY CONDITIONS. (WATCH OUT FOR SNEAKY TRICK WITH
C      COMMON BLOCKS CB07 AND CB08). AT THE END OF THE LOOP,
C      SUBROUTINE RELOAD SHOVES THE BOUNDARY CONDITIONS FOR THE
C      LOWEST ENERGY CONFIGURATION BACK INTO THE BOUNDARY CONDITION
C      COMMON BLOCKS (MORE SNEAKY TRICKS), AND SUBROUTINE PROFIL
C      WORKS OUT ALL THE CHARGE, FIELD AND VOLTAGE PROFILES AS
C      A FUNCTION OF POSITION.
C      SO, BACK TO THE STORY...  ..  .
C      SET UP MATH. CONSTANTS THAT ARE A FUNCTION OF ISET TO SAVE
C      REPEATED CALCULATION DURING NUMERICAL ITERATIONS
C      IN S/R CLOSLP
      CALL SETMTH
C      INITIALISE POINTER FOR STRADDLING VOLTAGE VECTOR
      IPTR=0
C      SWITCH OFF CHECKPOINT ROUTINE
      ICHECK=1
      ICHECK=0
C      DRAW CHECKPLOT IE FUNCTION  F VS VA
      CALL CKPLOT
C      CKPLOT RETURNS POSSVA FULL OF STRADDLING POINT PAIRS, AND
C      IPTR POINTING AT THE LAST OCCUPIED CELL.
C      IF NONE FOUND, IPTR IS STILL 0, SO PANIC
      IF(IPTR.EQ.0)CALL PANIC(15)
C      SWITCH ON CHECKPOINT ROUTINE
      ICHECK=1
      ICHECK=0
C      ISENSE IS A FLAG THAT IS SET WHEN A SENSIBLE SOLUTION IS FOUND
C      RESET ISENSE
      ISENSE=0
C      SET UP LOOP TO DEAL WITH ALL POSSIBLE SOLUTIONS, ONE SET AT
C      A TIME.
      WRITE(4,1001)
      WRITE(1,1001)
      DO 100 I=1,IPTR
C      SWITCH OFF CHECKPOINT ROUTINE
      ICHECK=0
C      SOLVE LOOP
      CALL CLOSLP(I,FLAST,II)
C      FLAST CONTAINS THE VALUE OF F THAT SATISFIED THE BISECTION
C      ROUTINE TO AN ACCURACY OF ACC1.
C      II IS THE NUMBER OF ITERATIONS REQUIRED TO SATISFY IT
C      CALCULATE ENERGY
C      GIVE SUBROUTINE ENERGY THE VALUE OF THE LOOP
C      VOLTAGE, COS IF IT'S SILLY, DON'T BOTHER TO CALCULATE
C      ENERGY
      CALL ENERGY(FLAST,ISENSE)
C      OUTPUT VOLTAGE AND ENERGY
C      AND LOOP VOLTAGE
      WRITE(1,1000)VA,UTOT,FLAST,II
      WRITE(4,1000)VA,UTOT,FLAST,II
1000  FORMAT(29H AQUEOUS INTERFACE VOLTAGE = ,1PE15.8,
     X17H SYSTEM ENERGY = ,1PE15.8,
     X16H LOOP VOLTAGE = ,1PE15.8,
     X4H IN ,I3,12H ITERATIONS.)
C      AND TRY THE NEXT
100   CONTINUE
      WRITE(1,1001)
      WRITE(4,1001)
1001  FORMAT(1X,125(1H*))
C      END OF LOOP. IF ANY SENSIBLE SOLUTIONS FOUND, SUBROUTINE
C      ENERGY WILL HAVE SET ISENSE
      IF(ISENSE.EQ.0)CALL PANIC(4)
C      NOE RELOAD BOUNDARY CONDITION COMMON BLOCKS
      CALL RELOAD
C      SWITCH OFF CHECKPOINT ROUTINE
      ICHECK=0
C      AND PLOT THE LUCKY WINNER
      CALL PROFIL
      RETURN
      END
C
C******
C
C
      SUBROUTINE CLOSLP(IADR,FC,II)
      COMMON/CB04/ACC1,ACC2,IFLAG
      COMMON/CB06/C1,C2,C3,C4,C5,C6,C7,VINV,EINV,VSTART,VEND
      COMMON/CB07/PHIS,VI,PSIL,VA,VALOX,VGATE,VSIOX
      COMMON/CB11/VSL(100,10),ESL(100,10),QSL(100,10),XSL(100),LIMSL,
     XXSLLOC,XMAXSL
      COMMON/CB12/VSI(100,10),ESI(100,10),QSI(100,10),XSI(100),LIMSI,
     XXSILOC,XMAXSI
      COMMON/CB14/ICHECK
      COMMON/CB15/IPTR,POSSVA(2,100),LPOSVA
      COMMON/CB25/ITHICK
      LOGICAL CKACC
C      ROUTINE TO CALCULATE BOUNDARY CONDITIONS FOR EACH INTERFACE
C      WHEN ACCURACY > ACC1.
C      SET ALL X COORDINATES TO 0.0 AS FUNCTIONS CALLED ARE
C      USED TO CALCULATE BULK VOLTAGES AS WELL AS THOSE AT THE
C      INTERFACE
C      IADR CONTAINS THE ADDRESS IN POSSVA OF THE TWO VOLTAGES
C      TO BE USED AS START POINTS FOR THE SOLUTION.
C      FC CONTAINS THE CLOSED LOOP VOLTAGE FOR SUBROUTINE DOASUM
C      II CONTAINS THE NUMBER OF ITERATIONS IT TOOK TO CLOSE
C      THE LOOP
C      SWITCH OFF CHECKPOINT ROUTINE
      ICHECK=0
      XSLLOC=0.0
      XSILOC=0.0
C      UNLOAD START AND END VOLTAGES FROM LIST SENT BY SUBROUTINE DOASUM
      V1=POSSVA(1,IADR)
      V2=POSSVA(2,IADR)
      FV1=F(V1)
      FV2=F(V2)
      CALL CK(64,FV1,'FV1   ','CLOSLP')
      CALL CK(65,FV2,'FV2   ','CLOSLP')
C      IF WE'RE USING THE THICK LAYER CKPLOT ALGORITHM,
C      RETURN DIRECT AS THE ANSWERS ALREADY CLOSE ENOUGH
      FC=FV1
      VA=V1
      II=0
      IF(ITHICK.EQ.1)RETURN
C      MAKE SURE START POINTS ARE SENSIBLE - PANIC IF NOT
      IF(S(FV1).EQ.S(FV2))CALL PANIC(11)
C      START ITERATION
      DO 100 I=1,32000
C      SAVE CONTROL PARAMETER
      II=I
C      IF WE'VE MEARLY FINISHED, SWITCH ON CHECKPOINT ROUTINE
      IF(I.GE.37)ICHECK=1
      ICHECK=0
      CALL CK(-1,FI,'******','******')
      FI=FLOAT(I)
      CALL CK(1 ,FI,'I     ','CLOSLP')
      CALL CK(2 ,V1    ,'V1    ','CLOSLP')
      CALL CK(3 ,V2    ,'V2    ','CLOSLP')
C      BISECT INTERVAL
      VA=(V1+V2)/2.0
      CALL CK(4 ,VA    ,'VA    ','CLOSLP')
C      SAVE VOLTAGE IN NON-COMMON VARIABLE
      VN=VA
C      IF REQUIRED ACCURACY ACHIEVED, JUMP OUT OF LOOP
      IF(CKACC(V1,V2,VA,ACC1))RETURN
      CALL CK(5 ,VA    ,'      ','CLOSLP')
C      NO, SO CALCULATE F(VN) AND ADJUST INTERVAL ACCORDINGLY
      FC=F(VN)
      CALL CK(6 ,FC    ,'FC    ','CLOSLP')
      SFC=S(FC)
      SFV1=S(FV1)
      SFV2=S(FV2)
      IF(SFC.EQ.SFV1)V1=VA
      IF(SFC.EQ.SFV1)FV1=FC
      IF(SFC.EQ.SFV2)V2=VA
      IF(SFC.EQ.SFV2)FV2=FC
C      INSURANCE AGAINST BEING LUCKY
      IF(FC.EQ.0.0)RETURN
C      AND TRY AGAIN
100   CONTINUE
C      NEVER HERE
      CALL PANIC(1)
      RETURN
C      OK, SO VA CONTAINS VOLTAGE VALUE FOR WHICH KVL IS TRUE.
C      IN THE SYSTEM
C      EQUATION F(VA) = 0.0 IS SOLVED USING BISECTION METHOD, WITH
C      INITIAL VALUES VSTART AND 0.0. ITERATIONS TERMINATED
C      ALL REQUIRED BOUNDARY CONDITIONS ARE IN COMMON, SET BY
C      FUNCTION F.
      END
C
C******
C
C
